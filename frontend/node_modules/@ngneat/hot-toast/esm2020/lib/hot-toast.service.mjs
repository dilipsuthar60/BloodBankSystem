import { isPlatformServer } from '@angular/common';
import { Inject, Injectable, Optional, PLATFORM_ID } from '@angular/core';
import { isComponent, isTemplateRef } from '@ngneat/overview';
import { defer } from 'rxjs';
import { tap } from 'rxjs/operators';
import { HotToastContainerComponent } from './components/hot-toast-container/hot-toast-container.component';
import { HOT_TOAST_DEFAULT_TIMEOUTS } from './constants';
import { HotToastRef } from './hot-toast-ref';
import { resolveValueOrFunction, ToastConfig, ToastPersistConfig, } from './hot-toast.model';
import * as i0 from "@angular/core";
import * as i1 from "@ngneat/overview";
import * as i2 from "./hot-toast.model";
export class HotToastService {
    constructor(_viewService, platformId, config) {
        this._viewService = _viewService;
        this.platformId = platformId;
        this._isInitialized = false;
        this._defaultConfig = new ToastConfig();
        this._defaultPersistConfig = new ToastPersistConfig();
        if (config) {
            this._defaultConfig = {
                ...this._defaultConfig,
                ...config,
            };
        }
    }
    get defaultConfig() {
        return this._defaultConfig;
    }
    set defaultConfig(config) {
        this._defaultConfig = {
            ...this._defaultConfig,
            ...config,
        };
        if (this._componentRef) {
            this._componentRef.setInput('defaultConfig', this._defaultConfig);
        }
    }
    /**
     * Opens up an hot-toast without any pre-configurations
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    show(message, options) {
        const toast = this.createToast(message || this._defaultConfig.blank.content, 'blank', {
            ...this._defaultConfig,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for error state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    error(message, options) {
        const toast = this.createToast(message || this._defaultConfig.error.content, 'error', {
            ...this._defaultConfig,
            ...this._defaultConfig?.error,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for success state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    success(message, options) {
        const toast = this.createToast(message || this._defaultConfig.success.content, 'success', {
            ...this._defaultConfig,
            ...this._defaultConfig?.success,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for loading state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    loading(message, options) {
        const toast = this.createToast(message || this._defaultConfig.loading.content, 'loading', {
            ...this._defaultConfig,
            ...this._defaultConfig?.loading,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for warning state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    warning(message, options) {
        const toast = this.createToast(message || this._defaultConfig.warning.content, 'warning', {
            ...this._defaultConfig,
            ...this._defaultConfig?.warning,
            ...options,
        });
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for info state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     * @since 3.3.0
     */
    info(message, options) {
        const toast = this.createToast(message || this._defaultConfig.info.content, 'info', {
            ...this._defaultConfig,
            ...this._defaultConfig?.info,
            ...options,
        });
        return toast;
    }
    /**
     *
     *  Opens up an hot-toast with pre-configurations for loading initially and then changes state based on messages
     *
     * @template T Type of observable
     * @param messages Messages for each state i.e. loading, success and error
     * @returns
     * @memberof HotToastService
     */
    observe(messages) {
        return (source) => {
            let toastRef;
            let start = 0;
            const loadingContent = messages.loading ?? this._defaultConfig.loading?.content;
            const successContent = messages.success ?? this._defaultConfig.success?.content;
            const errorContent = messages.error ?? this._defaultConfig.error?.content;
            return defer(() => {
                if (loadingContent) {
                    toastRef = this.createLoadingToast(loadingContent);
                    start = Date.now();
                }
                return source.pipe(tap({
                    ...(successContent && {
                        next: (val) => {
                            toastRef = this.createOrUpdateToast(messages, val, toastRef, 'success', start === 0 ? start : Date.now() - start);
                        },
                    }),
                    ...(errorContent && {
                        error: (e) => {
                            toastRef = this.createOrUpdateToast(messages, e, toastRef, 'error', start === 0 ? start : Date.now() - start);
                        },
                    }),
                }));
            });
        };
    }
    /**
     * Closes the hot-toast
     *
     * @param [id] - ID of the toast
     * @since 3.0.1 - If ID is not provided, all toasts will be closed
     */
    close(id) {
        if (this._componentRef) {
            this._componentRef.ref.instance.closeToast(id);
        }
    }
    /**
     * Used for internal purpose only.
     * Creates a container component and attaches it to document.body.
     */
    init() {
        if (isPlatformServer(this.platformId)) {
            return;
        }
        this._componentRef = this._viewService
            .createComponent(HotToastContainerComponent)
            .setInput('defaultConfig', this._defaultConfig)
            .appendTo(document.body);
    }
    createOrUpdateToast(messages, val, toastRef, type, diff) {
        let content = null;
        let options = {};
        ({ content, options } = this.getContentAndOptions(type, messages[type] || (this._defaultConfig[type] ? this._defaultConfig[type].content : '')));
        content = resolveValueOrFunction(content, val);
        if (toastRef) {
            toastRef.updateMessage(content);
            const updatedOptions = {
                type,
                duration: diff + HOT_TOAST_DEFAULT_TIMEOUTS[type],
                ...options,
                ...(options.duration && { duration: diff + options.duration }),
            };
            toastRef.updateToast(updatedOptions);
        }
        else {
            this.createToast(content, type, options);
        }
        return toastRef;
    }
    createToast(message, type, options, observableMessages) {
        if (!this._isInitialized) {
            this._isInitialized = true;
            this.init();
        }
        const now = Date.now();
        const id = options?.id ?? now.toString();
        if (!this.isDuplicate(id) &&
            (!options.persist?.enabled || (options.persist?.enabled && this.handleStorageValue(id, options)))) {
            const toast = {
                ariaLive: options?.ariaLive ?? 'polite',
                createdAt: now,
                duration: options?.duration ?? HOT_TOAST_DEFAULT_TIMEOUTS[type],
                id,
                message,
                role: options?.role ?? 'status',
                type,
                visible: true,
                observableMessages: observableMessages ?? undefined,
                ...options,
            };
            return new HotToastRef(toast).appendTo(this._componentRef.ref.instance);
        }
    }
    /**
     * Checks whether any toast with same id is present.
     *
     * @private
     * @param id - Toast ID
     */
    isDuplicate(id) {
        return this._componentRef.ref.instance.hasToast(id);
    }
    /**
     * Creates an entry in local or session storage with count ${defaultConfig.persist.count}, if not present.
     * If present in storage, reduces the count
     * and returns the count.
     * Count can not be less than 0.
     */
    handleStorageValue(id, options) {
        let count = 1;
        const persist = { ...this._defaultPersistConfig, ...options.persist };
        const storage = persist.storage === 'local' ? localStorage : sessionStorage;
        const key = persist.key.replace(/\${id}/g, id);
        let item = storage.getItem(key);
        if (item) {
            item = parseInt(item, 10);
            if (item > 0) {
                count = item - 1;
            }
            else {
                count = item;
            }
        }
        else {
            count = persist.count;
        }
        storage.setItem(key, count.toString());
        return count;
    }
    getContentAndOptions(toastType, message) {
        let content;
        let options = {
            ...this._defaultConfig,
            ...this._defaultConfig[toastType],
        };
        // typeof message === 'object' won't work, cz TemplateRef's type is object
        if (typeof message === 'string' || isTemplateRef(message) || isComponent(message)) {
            content = message;
        }
        else {
            let restOptions;
            ({ content, ...restOptions } = message);
            options = { ...options, ...restOptions };
        }
        return { content, options };
    }
    createLoadingToast(messages) {
        let content = null;
        let options = {};
        ({ content, options } = this.getContentAndOptions('loading', messages));
        return this.loading(content, options);
    }
}
HotToastService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: HotToastService, deps: [{ token: i1.ViewService }, { token: PLATFORM_ID }, { token: i2.ToastConfig, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
HotToastService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: HotToastService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: HotToastService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.ViewService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: i2.ToastConfig, decorators: [{
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ25lYXQvaG90LXRvYXN0L3NyYy9saWIvaG90LXRvYXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQW9CLFdBQVcsRUFBRSxhQUFhLEVBQWUsTUFBTSxrQkFBa0IsQ0FBQztBQUM3RixPQUFPLEVBQUUsS0FBSyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnRUFBZ0UsQ0FBQztBQUM1RyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlDLE9BQU8sRUFPTCxzQkFBc0IsRUFFdEIsV0FBVyxFQUVYLGtCQUFrQixHQUluQixNQUFNLG1CQUFtQixDQUFDOzs7O0FBRzNCLE1BQU0sT0FBTyxlQUFlO0lBTzFCLFlBQ1UsWUFBeUIsRUFDSixVQUFrQixFQUNuQyxNQUFtQjtRQUZ2QixpQkFBWSxHQUFaLFlBQVksQ0FBYTtRQUNKLGVBQVUsR0FBVixVQUFVLENBQVE7UUFSekMsbUJBQWMsR0FBRyxLQUFLLENBQUM7UUFHdkIsbUJBQWMsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQ25DLDBCQUFxQixHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQU92RCxJQUFJLE1BQU0sRUFBRTtZQUNWLElBQUksQ0FBQyxjQUFjLEdBQUc7Z0JBQ3BCLEdBQUcsSUFB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QyxDQUFDO1lBQ3hDLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxXQUFXLEVBQUUsR0FBRyxPQUE4RSxDQUFDLENBQUM7WUFDL0csT0FBTyxHQUFHLEVBQUUsR0FBRyxPQUFPLEVBQUUsR0FBRyxXQUFXLEVBQUUsQ0FBQztTQUMxQztRQUVELE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVPLGtCQUFrQixDQUFjLFFBQStDO1FBQ3JGLElBQUksT0FBTyxHQUEwQyxJQUFJLENBQUM7UUFDMUQsSUFBSSxPQUFPLEdBQXFDLEVBQUUsQ0FBQztRQUVuRCxDQUFDLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBZ0IsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFdkYsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQWtCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbkQsQ0FBQzs7NEdBaldVLGVBQWUsNkNBU2hCLFdBQVc7Z0hBVFYsZUFBZSxjQURGLE1BQU07MkZBQ25CLGVBQWU7a0JBRDNCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzswQkFVN0IsTUFBTTsyQkFBQyxXQUFXOzswQkFDbEIsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzUGxhdGZvcm1TZXJ2ZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbXBSZWYsIENvbnRlbnQsIGlzQ29tcG9uZW50LCBpc1RlbXBsYXRlUmVmLCBWaWV3U2VydmljZSB9IGZyb20gJ0BuZ25lYXQvb3ZlcnZpZXcnO1xuaW1wb3J0IHsgZGVmZXIsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgSG90VG9hc3RDb250YWluZXJDb21wb25lbnQgfSBmcm9tICcuL2NvbXBvbmVudHMvaG90LXRvYXN0LWNvbnRhaW5lci9ob3QtdG9hc3QtY29udGFpbmVyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBIT1RfVE9BU1RfREVGQVVMVF9USU1FT1VUUyB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IEhvdFRvYXN0UmVmIH0gZnJvbSAnLi9ob3QtdG9hc3QtcmVmJztcbmltcG9ydCB7XG4gIENyZWF0ZUhvdFRvYXN0UmVmLFxuICBEZWZhdWx0VG9hc3RPcHRpb25zLFxuICBIb3RUb2FzdFNlcnZpY2VNZXRob2RzLFxuICBPYnNlcnZhYmxlTG9hZGluZyxcbiAgT2JzZXJ2YWJsZU1lc3NhZ2VzLFxuICBPYnNlcnZhYmxlU3VjY2Vzc09yRXJyb3IsXG4gIHJlc29sdmVWYWx1ZU9yRnVuY3Rpb24sXG4gIFRvYXN0LFxuICBUb2FzdENvbmZpZyxcbiAgVG9hc3RPcHRpb25zLFxuICBUb2FzdFBlcnNpc3RDb25maWcsXG4gIFRvYXN0VHlwZSxcbiAgVXBkYXRlVG9hc3RPcHRpb25zLFxuICBWYWx1ZU9yRnVuY3Rpb24sXG59IGZyb20gJy4vaG90LXRvYXN0Lm1vZGVsJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBIb3RUb2FzdFNlcnZpY2UgaW1wbGVtZW50cyBIb3RUb2FzdFNlcnZpY2VNZXRob2RzIHtcbiAgcHJpdmF0ZSBfaXNJbml0aWFsaXplZCA9IGZhbHNlO1xuICBwcml2YXRlIF9jb21wb25lbnRSZWY6IENvbXBSZWY8SG90VG9hc3RDb250YWluZXJDb21wb25lbnQ+O1xuXG4gIHByaXZhdGUgX2RlZmF1bHRDb25maWcgPSBuZXcgVG9hc3RDb25maWcoKTtcbiAgcHJpdmF0ZSBfZGVmYXVsdFBlcnNpc3RDb25maWcgPSBuZXcgVG9hc3RQZXJzaXN0Q29uZmlnKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfdmlld1NlcnZpY2U6IFZpZXdTZXJ2aWNlLFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpIGNvbmZpZzogVG9hc3RDb25maWdcbiAgKSB7XG4gICAgaWYgKGNvbmZpZykge1xuICAgICAgdGhpcy5fZGVmYXVsdENvbmZpZyA9IHtcbiAgICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgICAgLi4uY29uZmlnLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBnZXQgZGVmYXVsdENvbmZpZygpIHtcbiAgICByZXR1cm4gdGhpcy5fZGVmYXVsdENvbmZpZztcbiAgfVxuICBzZXQgZGVmYXVsdENvbmZpZyhjb25maWc6IFRvYXN0Q29uZmlnKSB7XG4gICAgdGhpcy5fZGVmYXVsdENvbmZpZyA9IHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi5jb25maWcsXG4gICAgfTtcbiAgICBpZiAodGhpcy5fY29tcG9uZW50UmVmKSB7XG4gICAgICB0aGlzLl9jb21wb25lbnRSZWYuc2V0SW5wdXQoJ2RlZmF1bHRDb25maWcnLCB0aGlzLl9kZWZhdWx0Q29uZmlnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGhvdXQgYW55IHByZS1jb25maWd1cmF0aW9uc1xuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzaG93IGluIHRoZSBob3QtdG9hc3QuXG4gICAqIEBwYXJhbSBbb3B0aW9uc10gQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBob3QtdG9hc3QuXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICovXG4gIHNob3c8RGF0YVR5cGU+KG1lc3NhZ2U/OiBDb250ZW50LCBvcHRpb25zPzogVG9hc3RPcHRpb25zPERhdGFUeXBlPik6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlIHwgdW5rbm93bj4ge1xuICAgIGNvbnN0IHRvYXN0ID0gdGhpcy5jcmVhdGVUb2FzdDxEYXRhVHlwZT4obWVzc2FnZSB8fCB0aGlzLl9kZWZhdWx0Q29uZmlnLmJsYW5rLmNvbnRlbnQsICdibGFuaycsIHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIHVwIGFuIGhvdC10b2FzdCB3aXRoIHByZS1jb25maWd1cmF0aW9ucyBmb3IgZXJyb3Igc3RhdGVcbiAgICpcbiAgICogQHBhcmFtIG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gc2hvdyBpbiB0aGUgaG90LXRvYXN0LlxuICAgKiBAcGFyYW0gW29wdGlvbnNdIEFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgaG90LXRvYXN0LlxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqL1xuICBlcnJvcjxEYXRhVHlwZT4obWVzc2FnZT86IENvbnRlbnQsIG9wdGlvbnM/OiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+KTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgY29uc3QgdG9hc3QgPSB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlPihtZXNzYWdlIHx8IHRoaXMuX2RlZmF1bHRDb25maWcuZXJyb3IuY29udGVudCwgJ2Vycm9yJywge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWc/LmVycm9yLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcblxuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB1cCBhbiBob3QtdG9hc3Qgd2l0aCBwcmUtY29uZmlndXJhdGlvbnMgZm9yIHN1Y2Nlc3Mgc3RhdGVcbiAgICpcbiAgICogQHBhcmFtIG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gc2hvdyBpbiB0aGUgaG90LXRvYXN0LlxuICAgKiBAcGFyYW0gW29wdGlvbnNdIEFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgaG90LXRvYXN0LlxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqL1xuICBzdWNjZXNzPERhdGFUeXBlPihtZXNzYWdlPzogQ29udGVudCwgb3B0aW9ucz86IFRvYXN0T3B0aW9uczxEYXRhVHlwZT4pOiBDcmVhdGVIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+IHtcbiAgICBjb25zdCB0b2FzdCA9IHRoaXMuY3JlYXRlVG9hc3Q8RGF0YVR5cGU+KG1lc3NhZ2UgfHwgdGhpcy5fZGVmYXVsdENvbmZpZy5zdWNjZXNzLmNvbnRlbnQsICdzdWNjZXNzJywge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWc/LnN1Y2Nlc3MsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIHVwIGFuIGhvdC10b2FzdCB3aXRoIHByZS1jb25maWd1cmF0aW9ucyBmb3IgbG9hZGluZyBzdGF0ZVxuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzaG93IGluIHRoZSBob3QtdG9hc3QuXG4gICAqIEBwYXJhbSBbb3B0aW9uc10gQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBob3QtdG9hc3QuXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICovXG4gIGxvYWRpbmc8RGF0YVR5cGU+KG1lc3NhZ2U/OiBDb250ZW50LCBvcHRpb25zPzogVG9hc3RPcHRpb25zPERhdGFUeXBlPik6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlIHwgdW5rbm93bj4ge1xuICAgIGNvbnN0IHRvYXN0ID0gdGhpcy5jcmVhdGVUb2FzdDxEYXRhVHlwZT4obWVzc2FnZSB8fCB0aGlzLl9kZWZhdWx0Q29uZmlnLmxvYWRpbmcuY29udGVudCwgJ2xvYWRpbmcnLCB7XG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLFxuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZz8ubG9hZGluZyxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGggcHJlLWNvbmZpZ3VyYXRpb25zIGZvciB3YXJuaW5nIHN0YXRlXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIFRoZSBtZXNzYWdlIHRvIHNob3cgaW4gdGhlIGhvdC10b2FzdC5cbiAgICogQHBhcmFtIFtvcHRpb25zXSBBZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGhvdC10b2FzdC5cbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIEhvdFRvYXN0U2VydmljZVxuICAgKi9cbiAgd2FybmluZzxEYXRhVHlwZT4obWVzc2FnZT86IENvbnRlbnQsIG9wdGlvbnM/OiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+KTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgY29uc3QgdG9hc3QgPSB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlPihtZXNzYWdlIHx8IHRoaXMuX2RlZmF1bHRDb25maWcud2FybmluZy5jb250ZW50LCAnd2FybmluZycsIHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnPy53YXJuaW5nLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcblxuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB1cCBhbiBob3QtdG9hc3Qgd2l0aCBwcmUtY29uZmlndXJhdGlvbnMgZm9yIGluZm8gc3RhdGVcbiAgICpcbiAgICogQHBhcmFtIG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gc2hvdyBpbiB0aGUgaG90LXRvYXN0LlxuICAgKiBAcGFyYW0gW29wdGlvbnNdIEFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgaG90LXRvYXN0LlxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqIEBzaW5jZSAzLjMuMFxuICAgKi9cbiAgaW5mbzxEYXRhVHlwZT4obWVzc2FnZT86IENvbnRlbnQsIG9wdGlvbnM/OiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+KTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgY29uc3QgdG9hc3QgPSB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlPihtZXNzYWdlIHx8IHRoaXMuX2RlZmF1bHRDb25maWcuaW5mby5jb250ZW50LCAnaW5mbycsIHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnPy5pbmZvLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcblxuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiAgT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGggcHJlLWNvbmZpZ3VyYXRpb25zIGZvciBsb2FkaW5nIGluaXRpYWxseSBhbmQgdGhlbiBjaGFuZ2VzIHN0YXRlIGJhc2VkIG9uIG1lc3NhZ2VzXG4gICAqXG4gICAqIEB0ZW1wbGF0ZSBUIFR5cGUgb2Ygb2JzZXJ2YWJsZVxuICAgKiBAcGFyYW0gbWVzc2FnZXMgTWVzc2FnZXMgZm9yIGVhY2ggc3RhdGUgaS5lLiBsb2FkaW5nLCBzdWNjZXNzIGFuZCBlcnJvclxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqL1xuICBvYnNlcnZlPFQsIERhdGFUeXBlPihtZXNzYWdlczogT2JzZXJ2YWJsZU1lc3NhZ2VzPFQsIERhdGFUeXBlPik6IChzb3VyY2U6IE9ic2VydmFibGU8VD4pID0+IE9ic2VydmFibGU8VD4ge1xuICAgIHJldHVybiAoc291cmNlKSA9PiB7XG4gICAgICBsZXQgdG9hc3RSZWY6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlIHwgdW5rbm93bj47XG4gICAgICBsZXQgc3RhcnQgPSAwO1xuXG4gICAgICBjb25zdCBsb2FkaW5nQ29udGVudCA9IG1lc3NhZ2VzLmxvYWRpbmcgPz8gdGhpcy5fZGVmYXVsdENvbmZpZy5sb2FkaW5nPy5jb250ZW50O1xuICAgICAgY29uc3Qgc3VjY2Vzc0NvbnRlbnQgPSBtZXNzYWdlcy5zdWNjZXNzID8/IHRoaXMuX2RlZmF1bHRDb25maWcuc3VjY2Vzcz8uY29udGVudDtcbiAgICAgIGNvbnN0IGVycm9yQ29udGVudCA9IG1lc3NhZ2VzLmVycm9yID8/IHRoaXMuX2RlZmF1bHRDb25maWcuZXJyb3I/LmNvbnRlbnQ7XG5cbiAgICAgIHJldHVybiBkZWZlcigoKSA9PiB7XG4gICAgICAgIGlmIChsb2FkaW5nQ29udGVudCkge1xuICAgICAgICAgIHRvYXN0UmVmID0gdGhpcy5jcmVhdGVMb2FkaW5nVG9hc3Q8VCwgRGF0YVR5cGU+KGxvYWRpbmdDb250ZW50KTtcbiAgICAgICAgICBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNvdXJjZS5waXBlKFxuICAgICAgICAgIHRhcCh7XG4gICAgICAgICAgICAuLi4oc3VjY2Vzc0NvbnRlbnQgJiYge1xuICAgICAgICAgICAgICBuZXh0OiAodmFsKSA9PiB7XG4gICAgICAgICAgICAgICAgdG9hc3RSZWYgPSB0aGlzLmNyZWF0ZU9yVXBkYXRlVG9hc3Q8VCwgRGF0YVR5cGUgfCB1bmtub3duPihcbiAgICAgICAgICAgICAgICAgIG1lc3NhZ2VzLFxuICAgICAgICAgICAgICAgICAgdmFsLFxuICAgICAgICAgICAgICAgICAgdG9hc3RSZWYsXG4gICAgICAgICAgICAgICAgICAnc3VjY2VzcycsXG4gICAgICAgICAgICAgICAgICBzdGFydCA9PT0gMCA/IHN0YXJ0IDogRGF0ZS5ub3coKSAtIHN0YXJ0XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgLi4uKGVycm9yQ29udGVudCAmJiB7XG4gICAgICAgICAgICAgIGVycm9yOiAoZSkgPT4ge1xuICAgICAgICAgICAgICAgIHRvYXN0UmVmID0gdGhpcy5jcmVhdGVPclVwZGF0ZVRvYXN0PFQsIERhdGFUeXBlIHwgdW5rbm93bj4oXG4gICAgICAgICAgICAgICAgICBtZXNzYWdlcyxcbiAgICAgICAgICAgICAgICAgIGUsXG4gICAgICAgICAgICAgICAgICB0b2FzdFJlZixcbiAgICAgICAgICAgICAgICAgICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICBzdGFydCA9PT0gMCA/IHN0YXJ0IDogRGF0ZS5ub3coKSAtIHN0YXJ0XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENsb3NlcyB0aGUgaG90LXRvYXN0XG4gICAqXG4gICAqIEBwYXJhbSBbaWRdIC0gSUQgb2YgdGhlIHRvYXN0XG4gICAqIEBzaW5jZSAzLjAuMSAtIElmIElEIGlzIG5vdCBwcm92aWRlZCwgYWxsIHRvYXN0cyB3aWxsIGJlIGNsb3NlZFxuICAgKi9cbiAgY2xvc2UoaWQ/OiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5fY29tcG9uZW50UmVmKSB7XG4gICAgICB0aGlzLl9jb21wb25lbnRSZWYucmVmLmluc3RhbmNlLmNsb3NlVG9hc3QoaWQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVc2VkIGZvciBpbnRlcm5hbCBwdXJwb3NlIG9ubHkuXG4gICAqIENyZWF0ZXMgYSBjb250YWluZXIgY29tcG9uZW50IGFuZCBhdHRhY2hlcyBpdCB0byBkb2N1bWVudC5ib2R5LlxuICAgKi9cbiAgcHJpdmF0ZSBpbml0KCkge1xuICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fY29tcG9uZW50UmVmID0gdGhpcy5fdmlld1NlcnZpY2VcbiAgICAgIC5jcmVhdGVDb21wb25lbnQoSG90VG9hc3RDb250YWluZXJDb21wb25lbnQpXG4gICAgICAuc2V0SW5wdXQoJ2RlZmF1bHRDb25maWcnLCB0aGlzLl9kZWZhdWx0Q29uZmlnKVxuICAgICAgLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVPclVwZGF0ZVRvYXN0PFQsIERhdGFUeXBlPihcbiAgICBtZXNzYWdlczogT2JzZXJ2YWJsZU1lc3NhZ2VzPFQsIERhdGFUeXBlPixcbiAgICB2YWw6IHVua25vd24sXG4gICAgdG9hc3RSZWY6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlPixcbiAgICB0eXBlOiBUb2FzdFR5cGUsXG4gICAgZGlmZjogbnVtYmVyXG4gICkge1xuICAgIGxldCBjb250ZW50OiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+ID0gbnVsbDtcbiAgICBsZXQgb3B0aW9uczogVG9hc3RPcHRpb25zPERhdGFUeXBlIHwgdW5rbm93bj4gPSB7fTtcbiAgICAoeyBjb250ZW50LCBvcHRpb25zIH0gPSB0aGlzLmdldENvbnRlbnRBbmRPcHRpb25zPGFueSwgRGF0YVR5cGU+KFxuICAgICAgdHlwZSxcbiAgICAgIG1lc3NhZ2VzW3R5cGVdIHx8ICh0aGlzLl9kZWZhdWx0Q29uZmlnW3R5cGVdID8gdGhpcy5fZGVmYXVsdENvbmZpZ1t0eXBlXS5jb250ZW50IDogJycpXG4gICAgKSk7XG4gICAgY29udGVudCA9IHJlc29sdmVWYWx1ZU9yRnVuY3Rpb24oY29udGVudCwgdmFsKTtcbiAgICBpZiAodG9hc3RSZWYpIHtcbiAgICAgIHRvYXN0UmVmLnVwZGF0ZU1lc3NhZ2UoY29udGVudCk7XG4gICAgICBjb25zdCB1cGRhdGVkT3B0aW9uczogVXBkYXRlVG9hc3RPcHRpb25zPERhdGFUeXBlPiA9IHtcbiAgICAgICAgdHlwZSxcbiAgICAgICAgZHVyYXRpb246IGRpZmYgKyBIT1RfVE9BU1RfREVGQVVMVF9USU1FT1VUU1t0eXBlXSxcbiAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgLi4uKG9wdGlvbnMuZHVyYXRpb24gJiYgeyBkdXJhdGlvbjogZGlmZiArIG9wdGlvbnMuZHVyYXRpb24gfSksXG4gICAgICB9O1xuICAgICAgdG9hc3RSZWYudXBkYXRlVG9hc3QodXBkYXRlZE9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlLCBUPihjb250ZW50LCB0eXBlLCBvcHRpb25zKTtcbiAgICB9XG4gICAgcmV0dXJuIHRvYXN0UmVmO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVUb2FzdDxEYXRhVHlwZSwgVCA9IHVua25vd24+KFxuICAgIG1lc3NhZ2U6IENvbnRlbnQsXG4gICAgdHlwZTogVG9hc3RUeXBlLFxuICAgIG9wdGlvbnM/OiBEZWZhdWx0VG9hc3RPcHRpb25zLFxuICAgIG9ic2VydmFibGVNZXNzYWdlcz86IE9ic2VydmFibGVNZXNzYWdlczxULCBEYXRhVHlwZT5cbiAgKTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgaWYgKCF0aGlzLl9pc0luaXRpYWxpemVkKSB7XG4gICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgIHRoaXMuaW5pdCgpO1xuICAgIH1cblxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgaWQgPSBvcHRpb25zPy5pZCA/PyBub3cudG9TdHJpbmcoKTtcblxuICAgIGlmIChcbiAgICAgICF0aGlzLmlzRHVwbGljYXRlKGlkKSAmJlxuICAgICAgKCFvcHRpb25zLnBlcnNpc3Q/LmVuYWJsZWQgfHwgKG9wdGlvbnMucGVyc2lzdD8uZW5hYmxlZCAmJiB0aGlzLmhhbmRsZVN0b3JhZ2VWYWx1ZShpZCwgb3B0aW9ucykpKVxuICAgICkge1xuICAgICAgY29uc3QgdG9hc3Q6IFRvYXN0PERhdGFUeXBlIHwgdW5rbm93bj4gPSB7XG4gICAgICAgIGFyaWFMaXZlOiBvcHRpb25zPy5hcmlhTGl2ZSA/PyAncG9saXRlJyxcbiAgICAgICAgY3JlYXRlZEF0OiBub3csXG4gICAgICAgIGR1cmF0aW9uOiBvcHRpb25zPy5kdXJhdGlvbiA/PyBIT1RfVE9BU1RfREVGQVVMVF9USU1FT1VUU1t0eXBlXSxcbiAgICAgICAgaWQsXG4gICAgICAgIG1lc3NhZ2UsXG4gICAgICAgIHJvbGU6IG9wdGlvbnM/LnJvbGUgPz8gJ3N0YXR1cycsXG4gICAgICAgIHR5cGUsXG4gICAgICAgIHZpc2libGU6IHRydWUsXG4gICAgICAgIG9ic2VydmFibGVNZXNzYWdlczogb2JzZXJ2YWJsZU1lc3NhZ2VzID8/IHVuZGVmaW5lZCxcbiAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBuZXcgSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPih0b2FzdCkuYXBwZW5kVG8odGhpcy5fY29tcG9uZW50UmVmLnJlZi5pbnN0YW5jZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyB3aGV0aGVyIGFueSB0b2FzdCB3aXRoIHNhbWUgaWQgaXMgcHJlc2VudC5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtIGlkIC0gVG9hc3QgSURcbiAgICovXG4gIHByaXZhdGUgaXNEdXBsaWNhdGUoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl9jb21wb25lbnRSZWYucmVmLmluc3RhbmNlLmhhc1RvYXN0KGlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIGVudHJ5IGluIGxvY2FsIG9yIHNlc3Npb24gc3RvcmFnZSB3aXRoIGNvdW50ICR7ZGVmYXVsdENvbmZpZy5wZXJzaXN0LmNvdW50fSwgaWYgbm90IHByZXNlbnQuXG4gICAqIElmIHByZXNlbnQgaW4gc3RvcmFnZSwgcmVkdWNlcyB0aGUgY291bnRcbiAgICogYW5kIHJldHVybnMgdGhlIGNvdW50LlxuICAgKiBDb3VudCBjYW4gbm90IGJlIGxlc3MgdGhhbiAwLlxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVTdG9yYWdlVmFsdWUoaWQ6IHN0cmluZywgb3B0aW9uczogRGVmYXVsdFRvYXN0T3B0aW9ucyk6IG51bWJlciB7XG4gICAgbGV0IGNvdW50ID0gMTtcbiAgICBjb25zdCBwZXJzaXN0ID0geyAuLi50aGlzLl9kZWZhdWx0UGVyc2lzdENvbmZpZywgLi4ub3B0aW9ucy5wZXJzaXN0IH07XG4gICAgY29uc3Qgc3RvcmFnZTogU3RvcmFnZSA9IHBlcnNpc3Quc3RvcmFnZSA9PT0gJ2xvY2FsJyA/IGxvY2FsU3RvcmFnZSA6IHNlc3Npb25TdG9yYWdlO1xuICAgIGNvbnN0IGtleSA9IHBlcnNpc3Qua2V5LnJlcGxhY2UoL1xcJHtpZH0vZywgaWQpO1xuXG4gICAgbGV0IGl0ZW06IHN0cmluZyB8IG51bWJlciA9IHN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xuXG4gICAgaWYgKGl0ZW0pIHtcbiAgICAgIGl0ZW0gPSBwYXJzZUludChpdGVtLCAxMCk7XG4gICAgICBpZiAoaXRlbSA+IDApIHtcbiAgICAgICAgY291bnQgPSBpdGVtIC0gMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvdW50ID0gaXRlbTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY291bnQgPSBwZXJzaXN0LmNvdW50O1xuICAgIH1cblxuICAgIHN0b3JhZ2Uuc2V0SXRlbShrZXksIGNvdW50LnRvU3RyaW5nKCkpO1xuXG4gICAgcmV0dXJuIGNvdW50O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb250ZW50QW5kT3B0aW9uczxULCBEYXRhVHlwZT4oXG4gICAgdG9hc3RUeXBlOiBUb2FzdFR5cGUsXG4gICAgbWVzc2FnZTogQ29udGVudCB8IFZhbHVlT3JGdW5jdGlvbjxDb250ZW50LCBUPiB8IE9ic2VydmFibGVMb2FkaW5nPERhdGFUeXBlPiB8IE9ic2VydmFibGVTdWNjZXNzT3JFcnJvcjxULCBEYXRhVHlwZT5cbiAgKTogeyBvcHRpb25zOiBUb2FzdE9wdGlvbnM8RGF0YVR5cGUgfCB1bmtub3duPjsgY29udGVudDogQ29udGVudCB8IFZhbHVlT3JGdW5jdGlvbjxDb250ZW50LCBUPiB9IHtcbiAgICBsZXQgY29udGVudDogQ29udGVudCB8IFZhbHVlT3JGdW5jdGlvbjxDb250ZW50LCBUPjtcbiAgICBsZXQgb3B0aW9uczogVG9hc3RPcHRpb25zPERhdGFUeXBlIHwgdW5rbm93bj4gPSB7XG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLFxuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZ1t0b2FzdFR5cGVdLFxuICAgIH07XG5cbiAgICAvLyB0eXBlb2YgbWVzc2FnZSA9PT0gJ29iamVjdCcgd29uJ3Qgd29yaywgY3ogVGVtcGxhdGVSZWYncyB0eXBlIGlzIG9iamVjdFxuICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycgfHwgaXNUZW1wbGF0ZVJlZihtZXNzYWdlKSB8fCBpc0NvbXBvbmVudChtZXNzYWdlKSkge1xuICAgICAgY29udGVudCA9IG1lc3NhZ2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCByZXN0T3B0aW9uczogVG9hc3RPcHRpb25zPERhdGFUeXBlPjtcbiAgICAgICh7IGNvbnRlbnQsIC4uLnJlc3RPcHRpb25zIH0gPSBtZXNzYWdlIGFzIE9ic2VydmFibGVMb2FkaW5nPERhdGFUeXBlPiB8IE9ic2VydmFibGVTdWNjZXNzT3JFcnJvcjxULCBEYXRhVHlwZT4pO1xuICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgLi4ucmVzdE9wdGlvbnMgfTtcbiAgICB9XG5cbiAgICByZXR1cm4geyBjb250ZW50LCBvcHRpb25zIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxvYWRpbmdUb2FzdDxULCBEYXRhVHlwZT4obWVzc2FnZXM6IENvbnRlbnQgfCBPYnNlcnZhYmxlTG9hZGluZzxEYXRhVHlwZT4pIHtcbiAgICBsZXQgY29udGVudDogQ29udGVudCB8IFZhbHVlT3JGdW5jdGlvbjxDb250ZW50LCBUPiA9IG51bGw7XG4gICAgbGV0IG9wdGlvbnM6IFRvYXN0T3B0aW9uczxEYXRhVHlwZSB8IHVua25vd24+ID0ge307XG5cbiAgICAoeyBjb250ZW50LCBvcHRpb25zIH0gPSB0aGlzLmdldENvbnRlbnRBbmRPcHRpb25zPGFueSwgRGF0YVR5cGU+KCdsb2FkaW5nJywgbWVzc2FnZXMpKTtcblxuICAgIHJldHVybiB0aGlzLmxvYWRpbmcoY29udGVudCBhcyBDb250ZW50LCBvcHRpb25zKTtcbiAgfVxufVxuIl19