import { ChangeDetectionStrategy, Component, EventEmitter, Injector, Input, Output, ViewChild, } from '@angular/core';
import { isComponent, isTemplateRef } from '@ngneat/overview';
import { ENTER_ANIMATION_DURATION, EXIT_ANIMATION_DURATION } from '../../constants';
import { HotToastRef } from '../../hot-toast-ref';
import { animate } from '../../utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "@ngneat/overview";
import * as i3 from "../animated-icon/animated-icon.component";
import * as i4 from "../indicator/indicator.component";
export class HotToastComponent {
    constructor(injector, renderer, ngZone) {
        this.injector = injector;
        this.renderer = renderer;
        this.ngZone = ngZone;
        this.offset = 0;
        this.height = new EventEmitter();
        this.beforeClosed = new EventEmitter();
        this.afterClosed = new EventEmitter();
        this.isManualClose = false;
        this.unlisteners = [];
    }
    get containerPositionStyle() {
        const top = this.toast.position.includes('top');
        const verticalStyle = top ? { top: 0 } : { bottom: 0 };
        const horizontalStyle = this.toast.position.includes('left')
            ? {
                left: 0,
            }
            : this.toast.position.includes('right')
                ? {
                    right: 0,
                }
                : {
                    left: 0,
                    right: 0,
                    justifyContent: 'center',
                };
        return {
            transform: `translateY(${this.offset * (top ? 1 : -1)}px)`,
            ...verticalStyle,
            ...horizontalStyle,
        };
    }
    get toastBarBaseStyles() {
        const top = this.toast.position.includes('top');
        const enterAnimation = `hotToastEnterAnimation${top ? 'Negative' : 'Positive'} ${ENTER_ANIMATION_DURATION}ms cubic-bezier(0.21, 1.02, 0.73, 1) forwards`;
        const exitAnimation = `hotToastExitAnimation${top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1) ${this.toast.duration}ms`;
        const animation = this.toast.autoClose ? `${enterAnimation}, ${exitAnimation}` : enterAnimation;
        return { ...this.toast.style, animation };
    }
    get isIconString() {
        return typeof this.toast.icon === 'string';
    }
    ngOnInit() {
        if (isTemplateRef(this.toast.message)) {
            this.context = { $implicit: this.toastRef };
        }
        if (isComponent(this.toast.message)) {
            this.toastComponentInjector = Injector.create({
                providers: [
                    {
                        provide: HotToastRef,
                        useValue: this.toastRef,
                    },
                ],
                parent: this.toast.injector || this.injector,
            });
        }
    }
    ngAfterViewInit() {
        const nativeElement = this.toastBarBase.nativeElement;
        // Caretaker note: accessing `offsetHeight` triggers the whole layout update.
        // Macro tasks (like `setTimeout`) might be executed within the current rendering frame and cause a frame drop.
        requestAnimationFrame(() => {
            this.height.emit(nativeElement.offsetHeight);
        });
        // Caretaker note: `animationstart` and `animationend` events are event tasks that trigger change detection.
        // We'd want to trigger the change detection only if it's an exit animation.
        this.ngZone.runOutsideAngular(() => {
            this.unlisteners.push(
            // Caretaker note: we have to remove these event listeners at the end (even if the element is removed from DOM).
            // zone.js stores its `ZoneTask`s within the `nativeElement[Zone.__symbol__('animationstart') + 'false']` property
            // with callback that capture `this`.
            this.renderer.listen(nativeElement, 'animationstart', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.beforeClosed.emit());
                }
            }), this.renderer.listen(nativeElement, 'animationend', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.afterClosed.emit({ dismissedByAction: this.isManualClose, id: this.toast.id }));
                }
            }));
        });
        this.setToastAttributes();
    }
    close() {
        this.isManualClose = true;
        const top = this.toast.position.includes('top');
        const exitAnimation = `hotToastExitAnimation${top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1)`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, exitAnimation);
    }
    ngOnDestroy() {
        this.close();
        while (this.unlisteners.length) {
            this.unlisteners.pop()();
        }
    }
    isExitAnimation(ev) {
        return ev.animationName.includes('hotToastExitAnimation');
    }
    setToastAttributes() {
        const toastAttributes = this.toast.attributes;
        for (const [key, value] of Object.entries(toastAttributes)) {
            this.renderer.setAttribute(this.toastBarBase.nativeElement, key, value);
        }
    }
}
HotToastComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: HotToastComponent, deps: [{ token: i0.Injector }, { token: i0.Renderer2 }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Component });
HotToastComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.0.1", type: HotToastComponent, selector: "hot-toast", inputs: { toast: "toast", offset: "offset", defaultConfig: "defaultConfig", toastRef: "toastRef" }, outputs: { height: "height", beforeClosed: "beforeClosed", afterClosed: "afterClosed" }, viewQueries: [{ propertyName: "toastBarBase", first: true, predicate: ["hotToastBarBase"], descendants: true }], ngImport: i0, template: "<div\n  class=\"hot-toast-bar-base-container\"\n  [ngStyle]=\"containerPositionStyle\"\n  [ngClass]=\"'hot-toast-theme-' + toast.theme\"\n>\n  <div\n    class=\"hot-toast-bar-base\"\n    #hotToastBarBase\n    [ngStyle]=\"toastBarBaseStyles\"\n    [ngClass]=\"toast.className\"\n    [style.--hot-toast-animation-state]=\"isManualClose ? 'running' : 'paused'\"\n    [attr.aria-live]=\"toast.ariaLive\"\n    [attr.role]=\"toast.role\"\n  >\n    <div class=\"hot-toast-icon\" aria-hidden=\"true\">\n      <ng-container *ngIf=\"toast.icon !== undefined; else indicator\">\n        <ng-container *ngIf=\"isIconString; else iconTemplateOrComponent\">\n          <hot-toast-animated-icon [iconTheme]=\"toast.iconTheme\">{{ toast.icon }}</hot-toast-animated-icon>\n        </ng-container>\n        <ng-template #iconTemplateOrComponent>\n          <div>\n            <ng-container [dynamicView]=\"toast.icon\"></ng-container>\n          </div>\n        </ng-template>\n      </ng-container>\n\n      <ng-template #indicator>\n        <hot-toast-indicator [theme]=\"toast.iconTheme\" [type]=\"toast.type\"></hot-toast-indicator>\n      </ng-template>\n    </div>\n\n    <div class=\"hot-toast-message\">\n      <div>\n        <ng-container *dynamicView=\"toast.message; context: context; injector: toastComponentInjector\"></ng-container>\n      </div>\n    </div>\n\n    <button\n      *ngIf=\"toast.dismissible\"\n      (click)=\"close()\"\n      type=\"button\"\n      class=\"hot-toast-close-btn\"\n      aria-label=\"Close\"\n      [ngStyle]=\"toast.closeStyle\"\n    ></button>\n  </div>\n</div>\n", dependencies: [{ kind: "directive", type: i1.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i1.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { kind: "directive", type: i2.DynamicViewDirective, selector: "[dynamicView]", inputs: ["dynamicView", "dynamicViewInjector", "dynamicViewContext"] }, { kind: "component", type: i3.AnimatedIconComponent, selector: "hot-toast-animated-icon", inputs: ["iconTheme"] }, { kind: "component", type: i4.IndicatorComponent, selector: "hot-toast-indicator", inputs: ["theme", "type"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, preserveWhitespaces: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: HotToastComponent, decorators: [{
            type: Component,
            args: [{ selector: 'hot-toast', changeDetection: ChangeDetectionStrategy.OnPush, template: "<div\n  class=\"hot-toast-bar-base-container\"\n  [ngStyle]=\"containerPositionStyle\"\n  [ngClass]=\"'hot-toast-theme-' + toast.theme\"\n>\n  <div\n    class=\"hot-toast-bar-base\"\n    #hotToastBarBase\n    [ngStyle]=\"toastBarBaseStyles\"\n    [ngClass]=\"toast.className\"\n    [style.--hot-toast-animation-state]=\"isManualClose ? 'running' : 'paused'\"\n    [attr.aria-live]=\"toast.ariaLive\"\n    [attr.role]=\"toast.role\"\n  >\n    <div class=\"hot-toast-icon\" aria-hidden=\"true\">\n      <ng-container *ngIf=\"toast.icon !== undefined; else indicator\">\n        <ng-container *ngIf=\"isIconString; else iconTemplateOrComponent\">\n          <hot-toast-animated-icon [iconTheme]=\"toast.iconTheme\">{{ toast.icon }}</hot-toast-animated-icon>\n        </ng-container>\n        <ng-template #iconTemplateOrComponent>\n          <div>\n            <ng-container [dynamicView]=\"toast.icon\"></ng-container>\n          </div>\n        </ng-template>\n      </ng-container>\n\n      <ng-template #indicator>\n        <hot-toast-indicator [theme]=\"toast.iconTheme\" [type]=\"toast.type\"></hot-toast-indicator>\n      </ng-template>\n    </div>\n\n    <div class=\"hot-toast-message\">\n      <div>\n        <ng-container *dynamicView=\"toast.message; context: context; injector: toastComponentInjector\"></ng-container>\n      </div>\n    </div>\n\n    <button\n      *ngIf=\"toast.dismissible\"\n      (click)=\"close()\"\n      type=\"button\"\n      class=\"hot-toast-close-btn\"\n      aria-label=\"Close\"\n      [ngStyle]=\"toast.closeStyle\"\n    ></button>\n  </div>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i0.Injector }, { type: i0.Renderer2 }, { type: i0.NgZone }]; }, propDecorators: { toast: [{
                type: Input
            }], offset: [{
                type: Input
            }], defaultConfig: [{
                type: Input
            }], toastRef: [{
                type: Input
            }], height: [{
                type: Output
            }], beforeClosed: [{
                type: Output
            }], afterClosed: [{
                type: Output
            }], toastBarBase: [{
                type: ViewChild,
                args: ['hotToastBarBase']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nbmVhdC9ob3QtdG9hc3Qvc3JjL2xpYi9jb21wb25lbnRzL2hvdC10b2FzdC9ob3QtdG9hc3QuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmduZWF0L2hvdC10b2FzdC9zcmMvbGliL2NvbXBvbmVudHMvaG90LXRvYXN0L2hvdC10b2FzdC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFFVCxZQUFZLEVBQ1osUUFBUSxFQUNSLEtBQUssRUFJTCxNQUFNLEVBRU4sU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFOUQsT0FBTyxFQUFFLHdCQUF3QixFQUFFLHVCQUF1QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWxELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxhQUFhLENBQUM7Ozs7OztBQU90QyxNQUFNLE9BQU8saUJBQWlCO0lBa0I1QixZQUFvQixRQUFrQixFQUFVLFFBQW1CLEVBQVUsTUFBYztRQUF2RSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLFdBQU0sR0FBTixNQUFNLENBQVE7UUFoQmxGLFdBQU0sR0FBRyxDQUFDLENBQUM7UUFJVixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUNwQyxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDbEMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBaUIsQ0FBQztRQUkxRCxrQkFBYSxHQUFHLEtBQUss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RUosdUJBQXVCLENBQUMsTUFBTTs0SUFHdEMsS0FBSztzQkFBYixLQUFLO2dCQUNHLE1BQU07c0JBQWQsS0FBSztnQkFDRyxhQUFhO3NCQUFyQixLQUFLO2dCQUNHLFFBQVE7c0JBQWhCLEtBQUs7Z0JBRUksTUFBTTtzQkFBZixNQUFNO2dCQUNHLFlBQVk7c0JBQXJCLE1BQU07Z0JBQ0csV0FBVztzQkFBcEIsTUFBTTtnQkFFK0IsWUFBWTtzQkFBakQsU0FBUzt1QkFBQyxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdG9yLFxuICBJbnB1dCxcbiAgTmdab25lLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBSZW5kZXJlcjIsXG4gIFZpZXdDaGlsZCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpc0NvbXBvbmVudCwgaXNUZW1wbGF0ZVJlZiB9IGZyb20gJ0BuZ25lYXQvb3ZlcnZpZXcnO1xuXG5pbXBvcnQgeyBFTlRFUl9BTklNQVRJT05fRFVSQVRJT04sIEVYSVRfQU5JTUFUSU9OX0RVUkFUSU9OIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IEhvdFRvYXN0UmVmIH0gZnJvbSAnLi4vLi4vaG90LXRvYXN0LXJlZic7XG5pbXBvcnQgeyBDcmVhdGVIb3RUb2FzdFJlZiwgSG90VG9hc3RDbG9zZSwgVG9hc3QsIFRvYXN0Q29uZmlnIH0gZnJvbSAnLi4vLi4vaG90LXRvYXN0Lm1vZGVsJztcbmltcG9ydCB7IGFuaW1hdGUgfSBmcm9tICcuLi8uLi91dGlscyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2hvdC10b2FzdCcsXG4gIHRlbXBsYXRlVXJsOiAnaG90LXRvYXN0LmNvbXBvbmVudC5odG1sJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIEhvdFRvYXN0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICBASW5wdXQoKSB0b2FzdDogVG9hc3Q8dW5rbm93bj47XG4gIEBJbnB1dCgpIG9mZnNldCA9IDA7XG4gIEBJbnB1dCgpIGRlZmF1bHRDb25maWc6IFRvYXN0Q29uZmlnO1xuICBASW5wdXQoKSB0b2FzdFJlZjogQ3JlYXRlSG90VG9hc3RSZWY8dW5rbm93bj47XG5cbiAgQE91dHB1dCgpIGhlaWdodCA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPigpO1xuICBAT3V0cHV0KCkgYmVmb3JlQ2xvc2VkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgYWZ0ZXJDbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyPEhvdFRvYXN0Q2xvc2U+KCk7XG5cbiAgQFZpZXdDaGlsZCgnaG90VG9hc3RCYXJCYXNlJykgcHJpdmF0ZSB0b2FzdEJhckJhc2U6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+O1xuXG4gIGlzTWFudWFsQ2xvc2UgPSBmYWxzZTtcbiAgY29udGV4dDogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgdG9hc3RDb21wb25lbnRJbmplY3RvcjogSW5qZWN0b3I7XG5cbiAgcHJpdmF0ZSB1bmxpc3RlbmVyczogVm9pZEZ1bmN0aW9uW10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7fVxuXG4gIGdldCBjb250YWluZXJQb3NpdGlvblN0eWxlKCkge1xuICAgIGNvbnN0IHRvcCA9IHRoaXMudG9hc3QucG9zaXRpb24uaW5jbHVkZXMoJ3RvcCcpO1xuICAgIGNvbnN0IHZlcnRpY2FsU3R5bGUgPSB0b3AgPyB7IHRvcDogMCB9IDogeyBib3R0b206IDAgfTtcblxuICAgIGNvbnN0IGhvcml6b250YWxTdHlsZSA9IHRoaXMudG9hc3QucG9zaXRpb24uaW5jbHVkZXMoJ2xlZnQnKVxuICAgICAgPyB7XG4gICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgfVxuICAgICAgOiB0aGlzLnRvYXN0LnBvc2l0aW9uLmluY2x1ZGVzKCdyaWdodCcpXG4gICAgICA/IHtcbiAgICAgICAgICByaWdodDogMCxcbiAgICAgICAgfVxuICAgICAgOiB7XG4gICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgICByaWdodDogMCxcbiAgICAgICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsXG4gICAgICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgIHRyYW5zZm9ybTogYHRyYW5zbGF0ZVkoJHt0aGlzLm9mZnNldCAqICh0b3AgPyAxIDogLTEpfXB4KWAsXG4gICAgICAuLi52ZXJ0aWNhbFN0eWxlLFxuICAgICAgLi4uaG9yaXpvbnRhbFN0eWxlLFxuICAgIH07XG4gIH1cblxuICBnZXQgdG9hc3RCYXJCYXNlU3R5bGVzKCkge1xuICAgIGNvbnN0IHRvcCA9IHRoaXMudG9hc3QucG9zaXRpb24uaW5jbHVkZXMoJ3RvcCcpO1xuXG4gICAgY29uc3QgZW50ZXJBbmltYXRpb24gPSBgaG90VG9hc3RFbnRlckFuaW1hdGlvbiR7XG4gICAgICB0b3AgPyAnTmVnYXRpdmUnIDogJ1Bvc2l0aXZlJ1xuICAgIH0gJHtFTlRFUl9BTklNQVRJT05fRFVSQVRJT059bXMgY3ViaWMtYmV6aWVyKDAuMjEsIDEuMDIsIDAuNzMsIDEpIGZvcndhcmRzYDtcblxuICAgIGNvbnN0IGV4aXRBbmltYXRpb24gPSBgaG90VG9hc3RFeGl0QW5pbWF0aW9uJHtcbiAgICAgIHRvcCA/ICdOZWdhdGl2ZScgOiAnUG9zaXRpdmUnXG4gICAgfSAke0VYSVRfQU5JTUFUSU9OX0RVUkFUSU9OfW1zIGZvcndhcmRzIGN1YmljLWJlemllcigwLjA2LCAwLjcxLCAwLjU1LCAxKSAke3RoaXMudG9hc3QuZHVyYXRpb259bXNgO1xuXG4gICAgY29uc3QgYW5pbWF0aW9uID0gdGhpcy50b2FzdC5hdXRvQ2xvc2UgPyBgJHtlbnRlckFuaW1hdGlvbn0sICR7ZXhpdEFuaW1hdGlvbn1gIDogZW50ZXJBbmltYXRpb247XG5cbiAgICByZXR1cm4geyAuLi50aGlzLnRvYXN0LnN0eWxlLCBhbmltYXRpb24gfTtcbiAgfVxuXG4gIGdldCBpc0ljb25TdHJpbmcoKSB7XG4gICAgcmV0dXJuIHR5cGVvZiB0aGlzLnRvYXN0Lmljb24gPT09ICdzdHJpbmcnO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKGlzVGVtcGxhdGVSZWYodGhpcy50b2FzdC5tZXNzYWdlKSkge1xuICAgICAgdGhpcy5jb250ZXh0ID0geyAkaW1wbGljaXQ6IHRoaXMudG9hc3RSZWYgfTtcbiAgICB9XG4gICAgaWYgKGlzQ29tcG9uZW50KHRoaXMudG9hc3QubWVzc2FnZSkpIHtcbiAgICAgIHRoaXMudG9hc3RDb21wb25lbnRJbmplY3RvciA9IEluamVjdG9yLmNyZWF0ZSh7XG4gICAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHByb3ZpZGU6IEhvdFRvYXN0UmVmLFxuICAgICAgICAgICAgdXNlVmFsdWU6IHRoaXMudG9hc3RSZWYsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgcGFyZW50OiB0aGlzLnRvYXN0LmluamVjdG9yIHx8IHRoaXMuaW5qZWN0b3IsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQ7XG4gICAgLy8gQ2FyZXRha2VyIG5vdGU6IGFjY2Vzc2luZyBgb2Zmc2V0SGVpZ2h0YCB0cmlnZ2VycyB0aGUgd2hvbGUgbGF5b3V0IHVwZGF0ZS5cbiAgICAvLyBNYWNybyB0YXNrcyAobGlrZSBgc2V0VGltZW91dGApIG1pZ2h0IGJlIGV4ZWN1dGVkIHdpdGhpbiB0aGUgY3VycmVudCByZW5kZXJpbmcgZnJhbWUgYW5kIGNhdXNlIGEgZnJhbWUgZHJvcC5cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgdGhpcy5oZWlnaHQuZW1pdChuYXRpdmVFbGVtZW50Lm9mZnNldEhlaWdodCk7XG4gICAgfSk7XG5cbiAgICAvLyBDYXJldGFrZXIgbm90ZTogYGFuaW1hdGlvbnN0YXJ0YCBhbmQgYGFuaW1hdGlvbmVuZGAgZXZlbnRzIGFyZSBldmVudCB0YXNrcyB0aGF0IHRyaWdnZXIgY2hhbmdlIGRldGVjdGlvbi5cbiAgICAvLyBXZSdkIHdhbnQgdG8gdHJpZ2dlciB0aGUgY2hhbmdlIGRldGVjdGlvbiBvbmx5IGlmIGl0J3MgYW4gZXhpdCBhbmltYXRpb24uXG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy51bmxpc3RlbmVycy5wdXNoKFxuICAgICAgICAvLyBDYXJldGFrZXIgbm90ZTogd2UgaGF2ZSB0byByZW1vdmUgdGhlc2UgZXZlbnQgbGlzdGVuZXJzIGF0IHRoZSBlbmQgKGV2ZW4gaWYgdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIERPTSkuXG4gICAgICAgIC8vIHpvbmUuanMgc3RvcmVzIGl0cyBgWm9uZVRhc2tgcyB3aXRoaW4gdGhlIGBuYXRpdmVFbGVtZW50W1pvbmUuX19zeW1ib2xfXygnYW5pbWF0aW9uc3RhcnQnKSArICdmYWxzZSddYCBwcm9wZXJ0eVxuICAgICAgICAvLyB3aXRoIGNhbGxiYWNrIHRoYXQgY2FwdHVyZSBgdGhpc2AuXG4gICAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKG5hdGl2ZUVsZW1lbnQsICdhbmltYXRpb25zdGFydCcsIChldmVudDogQW5pbWF0aW9uRXZlbnQpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5pc0V4aXRBbmltYXRpb24oZXZlbnQpKSB7XG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4gdGhpcy5iZWZvcmVDbG9zZWQuZW1pdCgpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLnJlbmRlcmVyLmxpc3RlbihuYXRpdmVFbGVtZW50LCAnYW5pbWF0aW9uZW5kJywgKGV2ZW50OiBBbmltYXRpb25FdmVudCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLmlzRXhpdEFuaW1hdGlvbihldmVudCkpIHtcbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLmFmdGVyQ2xvc2VkLmVtaXQoeyBkaXNtaXNzZWRCeUFjdGlvbjogdGhpcy5pc01hbnVhbENsb3NlLCBpZDogdGhpcy50b2FzdC5pZCB9KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRoaXMuc2V0VG9hc3RBdHRyaWJ1dGVzKCk7XG4gIH1cblxuICBjbG9zZSgpIHtcbiAgICB0aGlzLmlzTWFudWFsQ2xvc2UgPSB0cnVlO1xuICAgIGNvbnN0IHRvcCA9IHRoaXMudG9hc3QucG9zaXRpb24uaW5jbHVkZXMoJ3RvcCcpO1xuXG4gICAgY29uc3QgZXhpdEFuaW1hdGlvbiA9IGBob3RUb2FzdEV4aXRBbmltYXRpb24ke1xuICAgICAgdG9wID8gJ05lZ2F0aXZlJyA6ICdQb3NpdGl2ZSdcbiAgICB9ICR7RVhJVF9BTklNQVRJT05fRFVSQVRJT059bXMgZm9yd2FyZHMgY3ViaWMtYmV6aWVyKDAuMDYsIDAuNzEsIDAuNTUsIDEpYDtcblxuICAgIGNvbnN0IG5hdGl2ZUVsZW1lbnQgPSB0aGlzLnRvYXN0QmFyQmFzZS5uYXRpdmVFbGVtZW50O1xuXG4gICAgYW5pbWF0ZShuYXRpdmVFbGVtZW50LCBleGl0QW5pbWF0aW9uKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuY2xvc2UoKTtcbiAgICB3aGlsZSAodGhpcy51bmxpc3RlbmVycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMudW5saXN0ZW5lcnMucG9wKCkoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzRXhpdEFuaW1hdGlvbihldjogQW5pbWF0aW9uRXZlbnQpIHtcbiAgICByZXR1cm4gZXYuYW5pbWF0aW9uTmFtZS5pbmNsdWRlcygnaG90VG9hc3RFeGl0QW5pbWF0aW9uJyk7XG4gIH1cblxuICBwcml2YXRlIHNldFRvYXN0QXR0cmlidXRlcygpIHtcbiAgICBjb25zdCB0b2FzdEF0dHJpYnV0ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB0aGlzLnRvYXN0LmF0dHJpYnV0ZXM7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModG9hc3RBdHRyaWJ1dGVzKSkge1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy50b2FzdEJhckJhc2UubmF0aXZlRWxlbWVudCwga2V5LCB2YWx1ZSk7XG4gICAgfVxuICB9XG59XG4iLCI8ZGl2XG4gIGNsYXNzPVwiaG90LXRvYXN0LWJhci1iYXNlLWNvbnRhaW5lclwiXG4gIFtuZ1N0eWxlXT1cImNvbnRhaW5lclBvc2l0aW9uU3R5bGVcIlxuICBbbmdDbGFzc109XCInaG90LXRvYXN0LXRoZW1lLScgKyB0b2FzdC50aGVtZVwiXG4+XG4gIDxkaXZcbiAgICBjbGFzcz1cImhvdC10b2FzdC1iYXItYmFzZVwiXG4gICAgI2hvdFRvYXN0QmFyQmFzZVxuICAgIFtuZ1N0eWxlXT1cInRvYXN0QmFyQmFzZVN0eWxlc1wiXG4gICAgW25nQ2xhc3NdPVwidG9hc3QuY2xhc3NOYW1lXCJcbiAgICBbc3R5bGUuLS1ob3QtdG9hc3QtYW5pbWF0aW9uLXN0YXRlXT1cImlzTWFudWFsQ2xvc2UgPyAncnVubmluZycgOiAncGF1c2VkJ1wiXG4gICAgW2F0dHIuYXJpYS1saXZlXT1cInRvYXN0LmFyaWFMaXZlXCJcbiAgICBbYXR0ci5yb2xlXT1cInRvYXN0LnJvbGVcIlxuICA+XG4gICAgPGRpdiBjbGFzcz1cImhvdC10b2FzdC1pY29uXCIgYXJpYS1oaWRkZW49XCJ0cnVlXCI+XG4gICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwidG9hc3QuaWNvbiAhPT0gdW5kZWZpbmVkOyBlbHNlIGluZGljYXRvclwiPlxuICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwiaXNJY29uU3RyaW5nOyBlbHNlIGljb25UZW1wbGF0ZU9yQ29tcG9uZW50XCI+XG4gICAgICAgICAgPGhvdC10b2FzdC1hbmltYXRlZC1pY29uIFtpY29uVGhlbWVdPVwidG9hc3QuaWNvblRoZW1lXCI+e3sgdG9hc3QuaWNvbiB9fTwvaG90LXRvYXN0LWFuaW1hdGVkLWljb24+XG4gICAgICAgIDwvbmctY29udGFpbmVyPlxuICAgICAgICA8bmctdGVtcGxhdGUgI2ljb25UZW1wbGF0ZU9yQ29tcG9uZW50PlxuICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICA8bmctY29udGFpbmVyIFtkeW5hbWljVmlld109XCJ0b2FzdC5pY29uXCI+PC9uZy1jb250YWluZXI+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvbmctdGVtcGxhdGU+XG4gICAgICA8L25nLWNvbnRhaW5lcj5cblxuICAgICAgPG5nLXRlbXBsYXRlICNpbmRpY2F0b3I+XG4gICAgICAgIDxob3QtdG9hc3QtaW5kaWNhdG9yIFt0aGVtZV09XCJ0b2FzdC5pY29uVGhlbWVcIiBbdHlwZV09XCJ0b2FzdC50eXBlXCI+PC9ob3QtdG9hc3QtaW5kaWNhdG9yPlxuICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICA8L2Rpdj5cblxuICAgIDxkaXYgY2xhc3M9XCJob3QtdG9hc3QtbWVzc2FnZVwiPlxuICAgICAgPGRpdj5cbiAgICAgICAgPG5nLWNvbnRhaW5lciAqZHluYW1pY1ZpZXc9XCJ0b2FzdC5tZXNzYWdlOyBjb250ZXh0OiBjb250ZXh0OyBpbmplY3RvcjogdG9hc3RDb21wb25lbnRJbmplY3RvclwiPjwvbmctY29udGFpbmVyPlxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG5cbiAgICA8YnV0dG9uXG4gICAgICAqbmdJZj1cInRvYXN0LmRpc21pc3NpYmxlXCJcbiAgICAgIChjbGljayk9XCJjbG9zZSgpXCJcbiAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgY2xhc3M9XCJob3QtdG9hc3QtY2xvc2UtYnRuXCJcbiAgICAgIGFyaWEtbGFiZWw9XCJDbG9zZVwiXG4gICAgICBbbmdTdHlsZV09XCJ0b2FzdC5jbG9zZVN0eWxlXCJcbiAgICA+PC9idXR0b24+XG4gIDwvZGl2PlxuPC9kaXY+XG4iXX0=